extends Node2D

#set before game starts
const in_edit_mode: bool = true
var current_level_name = "RHYTHM_COW"

# Time it takes for fk to reach crit point
var fk_fall_time: float = 1.5
var fk_output_arr = [[],[],[],[]]

var level_info = {
	"RHYTHM_COW" = {
		"fk_times": "[[0.16390025615692, 1.93446707725525, 3.31038570404053, 5.20893430709839, 7.53415012359619, 12.1632652282715, 14.3924713134766, 15.9390468597412, 16.1417236328125, 16.376371383667, 17.4429931640625, 18.2855777740479, 19.9814968109131, 21.1121082305908, 22.776008605957, 25.3358726501465, 27.479772567749, 30.5302963256836, 32.0128784179688, 32.4608612060547, 32.9941482543945, 36.5352821350098, 38.8071670532227, 40.9937400817871, 42.678955078125, 43.585578918457, 44.9081649780273, 45.8147850036621, 46.2947845458984, 47.1267127990723, 47.5853500366211, 48.1399993896484, 49.5266227722168, 49.9745559692383, 50.7745132446289, 51.2545127868652, 53.611701965332, 55.0089797973633, 55.5102958679199, 56.4275741577148, 56.8755569458008, 57.3555107116699, 58.3794555664063, 58.7634468078613, 61.8246269226074], [0.9851701259613, 2.86240339279175, 4.38766431808472, 5.65691614151001, 7.01151943206787, 8.44077110290527, 9.33673477172852, 11.2459859848022, 13.0378684997559, 15.3310661315918, 15.6297512054443, 17.2403182983398, 17.8269386291504, 19.0642185211182, 19.5121994018555, 20.6321544647217, 21.5280723571777, 22.2640361785889, 24.2585945129395, 25.5812244415283, 26.8611335754395, 28.3650798797607, 30.0823135375977, 31.4369163513184, 33.4101142883301, 35.330020904541, 35.9913368225098, 37.9751930236816, 39.6284790039063, 40.7590484619141, 41.5590019226074, 42.9562797546387, 44.4601821899414, 45.356143951416, 48.8119735717773, 49.1106109619141, 51.7344665527344, 52.705078125, 53.1637191772461, 59.1260757446289, 60.7900238037109, 61.1313362121582, 61.355281829834, 61.4833106994629], [0.59052157402039, 1.46517014503479, 2.88376426696777, 3.36371898651123, 4.79297065734863, 6.54222202301025, 7.5448522567749, 8.87809562683105, 10.3393650054932, 10.7659864425659, 13.976508140564, 15.1390933990479, 15.5124263763428, 16.0457134246826, 16.2803630828857, 17.0163269042969, 17.5922908782959, 18.0829486846924, 18.4349212646484, 18.8615417480469, 19.3095245361328, 19.8641719818115, 20.130838394165, 20.4828109741211, 20.8561458587646, 21.7947387695313, 22.5307025909424, 23.0639915466309, 23.533332824707, 23.8106117248535, 24.0559635162354, 25.026575088501, 25.8798637390137, 26.402494430542, 27.2451248168945, 27.6610889434814, 27.8957366943359, 28.7810440063477, 29.5596828460693, 31.0102500915527, 33.8367805480957, 34.8393669128418, 35.7353286743164, 36.1939697265625, 37.4632186889648, 38.4338760375977, 39.8631286621094, 40.5350570678711, 41.20703125, 41.8150100708008, 42.4763259887695, 43.1269378662109, 43.5749206542969, 44.0442161560059, 44.5135154724121, 44.9081649780273, 45.3775062561035, 46.2841262817383, 47.5853500366211, 49.089298248291, 49.5266227722168, 49.9639015197754, 50.7745132446289, 51.2864837646484, 52.7370986938477, 53.5903854370117, 54.5823135375977, 55.5102958679199, 56.459545135498, 56.907527923584, 57.3768692016602, 58.3901138305664, 58.7741050720215, 60.9926528930664, 61.2593193054199, 61.4086151123047], [1.94512462615967, 3.89700698852539, 6.56353759765625, 8.88875293731689, 12.5898866653442, 14.6591377258301, 16.7923355102539, 18.6802272796631, 20.3121547698975, 22.0080718994141, 24.6106128692627, 26.1145133972168, 29.1330165863037, 34.4340591430664, 37.0579147338867, 39.063175201416, 40.2790946960449, 42.1776428222656, 44.0762367248535, 45.7934684753418, 47.1267127990723, 48.1399993896484, 48.790657043457, 51.7771415710449, 53.1530609130859, 54.593017578125, 55.0089797973633, 56.4809074401855, 56.8862113952637, 57.3768692016602, 58.3794555664063]]
",
		"music": load("res://assets/audio/cowaudio.wav")
	}
}

func _ready():
	
	$SongPlayer.stream = level_info.get(current_level_name).get("music")
	$SongPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListnerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_LEFT"
				1:
					button_name = "button_DOWN"
				2:
					button_name = "button_UP"
				3:
					button_name = "button_RIGHT"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
				
			counter +=1

func KeyListenerPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str($SongPlayer.get_playback_position()))
	fk_output_arr[array_num].append($SongPlayer.get_playback_position() - fk_fall_time)


func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_song_player_finished() -> void:
	print(fk_output_arr)
