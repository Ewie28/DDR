extends Node2D

#set before game starts
const in_edit_mode: bool = false
var current_level_name = "RHYTHM_COW"

# Time it takes for fk to reach crit point
var fk_fall_time: float = 1.5
var fk_output_arr = [[],[],[],[]]

var level_info = {
	"RHYTHM_COW" = {
		"fk_times": "[[0.16390025615692, 3.77968263626099, 5.63560104370117, 6.61687088012695, 7.57682514190674, 9.37941074371338, 11.2139682769775, 14.0298414230347, 16.728343963623, 19.4588661193848, 22.274694442749, 24.4399547576904, 25.6131973266602, 27.479772567749, 27.9597282409668, 28.4077091217041, 29.7623138427734, 32.0448532104492, 32.5568237304688, 34.0607719421387, 35.0420417785645, 35.6606788635254, 36.1833114624023, 37.0899314880371, 38.9138336181641, 39.3937873840332, 43.5749206542969, 45.3881645202637, 46.3054428100586, 48.1080284118652, 49.9745559692383, 50.85986328125, 51.3078460693359, 51.8304748535156, 52.705078125, 53.1637191772461, 53.6437187194824, 54.593017578125, 55.0409507751465, 55.531608581543, 56.459545135498, 56.9395446777344, 57.3768692016602], [0.96385478973389, 2.88376426696777, 4.72897958755493, 8.43011379241943, 10.3393650054932, 12.6645803451538, 15.0111103057861, 18.1149215698242, 20.3868026733398, 23.2560081481934, 23.9599552154541, 26.5304756164551, 30.1889801025391, 31.0956001281738, 33.6767807006836, 34.4873924255371, 37.7938766479492, 38.4445343017578, 40.3430824279785, 42.6256217956543, 44.5135154724121, 45.8574600219727, 47.1267127990723, 48.5879821777344, 49.55859375, 50.838550567627, 58.4541053771973, 58.7741050720215], [0.55854868888855, 1.46517014503479, 3.33170080184937, 5.18761920928955, 7.5661678314209, 8.85678005218506, 10.7873468399048, 13.0591840744019, 14.4777774810791, 15.8643989562988, 17.6136512756348, 18.6375961303711, 19.9601821899414, 20.8774604797363, 22.776008605957, 23.7146492004395, 24.1946029663086, 25.1865768432617, 26.0611782073975, 27.01047706604, 29.3143310546875, 29.7623138427734, 31.5648994445801, 32.8768272399902, 36.6099319458008, 38.0285263061523, 39.8844451904297, 40.7910652160645, 41.6763725280762, 42.3909759521484, 43.0629463195801, 44.0868949890137, 44.9295234680176, 45.878776550293, 46.2947845458984, 47.1374168395996, 47.5746955871582, 48.1080284118652, 48.6092987060547, 49.0572776794434, 49.5799102783203, 49.9852600097656, 51.3291625976563, 51.8091621398926, 52.7264404296875, 53.1744232177734, 53.6543769836426, 58.4541053771973, 58.8061218261719, 61.8886184692383], [1.94512462615967, 4.29165554046631, 7.08616733551025, 8.40879821777344, 9.35805034637451, 12.2165985107422, 17.1656684875488, 21.3360996246338, 24.6639003753662, 25.5918827056885, 28.8343772888184, 30.658275604248, 32.2795028686523, 37.5592308044434, 39.3937873840332, 41.20703125, 42.135009765625, 45.3775062561035, 47.5853500366211, 49.0572776794434, 51.8411331176758, 52.7370986938477, 53.1850776672363, 53.6756935119629, 54.614330291748, 55.0836296081543, 55.5422668457031, 56.4915657043457, 56.9608612060547, 57.3875274658203]]
",
		"music": load("res://assets/audio/cowaudio.wav")
	}
}

func _ready():
	
	$SongPlayer.stream = level_info.get(current_level_name).get("music")
	$SongPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListnerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_LEFT"
				1:
					button_name = "button_DOWN"
				2:
					button_name = "button_UP"
				3:
					button_name = "button_RIGHT"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
				
			counter +=1

func KeyListenerPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str($SongPlayer.get_playback_position()))
	fk_output_arr[array_num].append($SongPlayer.get_playback_position() - fk_fall_time)


func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_song_player_finished() -> void:
	print(fk_output_arr)
